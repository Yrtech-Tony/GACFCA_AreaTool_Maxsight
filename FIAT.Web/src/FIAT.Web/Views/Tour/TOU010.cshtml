@*
    For more information on enabling MVC for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    ViewData["Title"] = "检核登记";
    Layout = "~/Views/Shared/_LayoutMenu.cshtml";
}
<style>
    .inputWidth {
        width: 30% !important;
    }

    .inputMaxWidth {
        max-width: 57% !important;
    }

    .aline {
        text-decoration: underline;
        font-size: 12px;
    }

    #selServerLst.orgWidth {
        width: 25%;
    }
</style>
@section scripts{
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=1.4"></script>
    <script type="text/javascript" src="http://developer.baidu.com/map/jsdemo/demo/convertor.js"></script>
    <script type="text/javascript">
            function fn_GetLocation() {
                //根据IP获取城市
                var myCity = new BMap.LocalCity();
                myCity.get(getCityByIP);
            }

            //根据IP获取城市
            function getCityByIP(rs) {
                _collAddr = rs.name;
                
                console.log("业务巡检地点："+(_collAddr==undefined||_collAddr==null?"无":_collAddr));
            }

    </script>
    <!-- 1. Load -->
    <script type="text/javascript">
        var _grid, _gridName;
        var _grid2, _gridName2;
        var _tpStatus;
        var _rowNo;
        var _disId = 0;
        var _collAddr = "";
        $(document).ready(function () {
            fn_GetLocation();
            fn_Initialize();
            fn_InitGrid();
            //拜访类型
            fn_SetVType();

            $("#selVisitType").on("change",function(){
                fn_getPlans();
            });

            $("#selPlanLst").on("change",function(){
                fn_SetServerData();
            });

            $("#selServerLst").change(function () {
                var disId = $(this).val();
                if(disId!="select"){
                    _disId=disId;
                    fn_Search(disId);
                }else {
                    fn_SetGrid("");
                    fn_SetGrid2("");
                }
            });
            $("#btnSave").on("click", function () {
                fn_Save();
            });
            //btnSelect
            $("#btnSelect").on("click", function () {
                fn_SelectDistributor();
            });
            $("#btnImpItem").on("click", function () {
                fn_OpenImpItemRegPop();
            });
            $("#btnExcelUpload").on("click",function(){
                $("#files").val("");
                $('#files').click();
            });
            $("#btnExcelDown").on("click",function(){
                //location.href = "~/Template/Score.xlsx";
                document.getElementById("a").click();
            });
            $("#upload").click(function (evt) {
                var fileUpload = $("#files").get(0);
                var files = fileUpload.files;
                var data = new FormData();
                for (var i = 0; i < files.length ; i++) {
                    data.append(files[i].name, files[i]);
                }
                $.ajax({
                    type: "POST",
                    url: "/Tour/UploadScoreAjax",
                    contentType: false,
                    processData: false,
                    data: data,
                    success: function (message) {
                        // alert(message);
                        if (JSON.parse(message).Success == true) {
                            fn_ExcelUpload(message);
                            //$.sa.warning("上传成功");
                        } else {
                            $.sa.warning("上传失败,请重试.");
                        }
                    },
                    error: function () {
                        $.sa.warning("上传失败,请重试.");
                    }
                });
            });
        });
    </script>
    <!-- 2. Init -->
    <script type="text/javascript">
        function fn_Initialize() {

            _gridName = 'gridTask';
            _grid = $('#' + _gridName);

            _gridName2 = 'gridItem';
            _grid2 = $('#' + _gridName2);
            $("#files").change(function () {
                $("#fileText").val($(this).val());
                $("#upload").click();
            })
        }
        function fn_InitGrid() {
            fn_GridInit();
            fn_GridInit2();
        }
        function fn_SetServerData(){
            if ($("#selPlanLst").val()==="select") {
                $("#ƒ").html(JsonToCboList("DisName", "DisId","", { 'SelectType': 'Select' }));
                return;
            }
            $.sa.get(
                GETTOURDISTRIBUTORLIST,
               //'http://localhost:6502/fiat/api/v1/Tour/GetTourDistributorList',
                           {
                               Batch: $("#selPlanLst").val()
                               ,UserId: "@Context.Request.Cookies[SessionKeys.SESSION_USERID]"
                               , disCode:'%'
                               , disName:'%'
                               , searchType:"R"
                           },
                           {
                               "success": function (data) {
                                   if (data != null && JSON.parse(data.body).length > 0) {
                                       $("#selServerLst").html(JsonToCboList("DisName", "DisId", JSON.parse(data.body), { 'SelectType': 'Select' }));
                                   }else{
                                       $("#selServerLst").html(JsonToCboList("DisName", "DisId","", { 'SelectType': 'Select' }));
                                   }
                               },
                               "failure": function (data, statusText, jqXHR) {
                               }
                           });
        }
    </script>
    <!-- 3. Validate -->
    <script type="text/javascript">
        function fn_GridValidate(editData) {
            if (editData.length <= 0) {
                $.sa.warning("没有要保存的数据");
                return false;
            }
            return true;
        }
    </script>

    <!-- 4. Custom Function -->
    <script type="text/javascript">

        function fn_Search(disId) {
            //$.sa.get("http://localhost:6502/fiat/api/v1/Tour/GetTaskListByDisId",
            $.sa.get(GETTASKLISTBYDISID,
                     {
                         disId: disId
                         , startTime: ""
                         , endTime: ""
                         , status: ""
                         , sourceType: 'D'
                         ,inUserId:'@Context.Request.Cookies[SessionKeys.SESSION_USERID]'
                         ,batch:$("#selPlanLst").val()
                     },
                     {
                         "success": function (data) {
                             fn_SetGrid2([]);
                             fn_SetGrid(JSON.parse(data.body));
                             if (JSON.parse(data.body).length > 0) {
                                 if(JSON.parse(data.body)[0].LastPScore)
                                     $("#divDealerTScore").html("近期明检总分：<span style='font-weight:bold; font-size:18px;'>" + JSON.parse(data.body)[0].LastPScore+ "</span>");
                                 else
                                     $("#divDealerTScore").html("");
                             }
                         },
                         "failure": function (data) {
                             alert(data.msg);
                         }
                     }, $("body"));
        }

        function fn_CheckStart(cellvalue, options, rowObject) {
            return '<button type="button" class="btn btn-primary start"  onclick="fn_Start_Proxy(' + options.rowId + ',\'S\',this)">开始</button>';
        }
        function fn_UnCheckStart() {

            return "";
        }

        function fn_CheckEnd(cellvalue, options, rowObject) {
            return '<button type="button" class="btn btn-primary end"  onclick="fn_Start(' + options.rowId + ',\'E\',this)">结束</button>';
        }
        function fn_UnCheckEnd() {

            return "";
        }
        function fn_ScoreReg(cellvalue, options, rowObject) {
            return '<button type="button" class="btn btn-primary score"  onclick="fn_ScoreRegPop(' + options.rowId + ',true)">检核登记</button>';
        }
        function fn_UnScoreReg() {
            return "";
        }
        function fn_CloseTask(cellvalue, options, rowObject) {
            return '<button type="button" class="btn btn-primary end"  onclick="fn_CloseTaskPlan(' + options.rowId + ',\'C\',this)">取消任务</button>';
        }
        function fn_UnCloseTask() {
            return "";
        }

        function fn_Start_Proxy(rowId, operation, obj){
            var selType =$("#selVisitType").val();
            if(selType == "A"){
                var popHeight = 250;
                var popWidth = 500;
                $.sa.pop('/Tour/SetSales', {
                    height: popHeight, width: popWidth, title: '<span class="fa fa-hand-o-right gap-icon-right"></span><span>销售人员设置</span>',
                    params: {
                        batch:$("#selPlanLst").val(),
                        disId:$("#selServerLst").val()
                    }
                  , popcallback: function (msg) {
                      if (msg != null && msg.length > 0) {
                          fn_Start(rowId,operation,obj);
                      }
                  }
                });            
            }        
        }

        var _currentObjMST;
        function fn_Start(rowId, operation, obj) {
            var rowObject = $("#gridTask").jqGrid('getRowData', rowId);
            _tpStatus = rowObject.TPStatus;
            if (_tpStatus == "检查完成") {
                operation = "";
            }
            _rowNo = rowId;
            var tpType = rowObject.TPType;

            if (tpType=="C") {
                if (operation == "E") {
                    $.sa.get(GETCUSTOMIZEDTASKBYTASKID,
                        {
                            taskId: rowObject.TPId
                            , operation: operation
                            , collAddr: _collAddr
                        },
                        {
                            "success": function (data) {
                                fn_Search(_disId);
                            },
                            "failure": function (data) {
                                $.sa.warning(data.msg);
                            }
                        }, $("body"));
                }else{
                    fn_SetGrid2([]);
                    fn_CustomizedTaskPop(rowObject.TPId,operation,_tpStatus);
                }
            }else{
                if(operation=="E"){
                    $.sa.confirm('结束检查后不能修改，确定要结束么？', {
                        fnOk: function () {
                            $(".close").click();
                //$.sa.get("http://fiatqaapi.elandcloud.com/fiat/api/v1/Tour/GetItemListByTaskId",
                            $.sa.get(GETITEMLISTBYTASKID,
                                     {
                                         taskId: rowObject.TPId
                                         , operation: operation
                                         , collAddr: _collAddr
                                     },
                                     {
                                         "success": function (data) {
                                             // 结束之后重新查询
                                             if (operation == "E") {
                                                 fn_Search(_disId);
                                                 fn_SetGrid2([]);
                                             } else {
                                                 fn_SetGrid2(JSON.parse(data.body));
                                             }

                                                     },
                                                     "failure": function (data) {
                                                         $.sa.warning(data.msg);
                                                     }
                                                 }, $("body"));
                        }
                    });
                }else{
                    //$.sa.get("http://fiatqaapi.elandcloud.com/fiat/api/v1/Tour/GetItemListByTaskId",
                    $.sa.get(GETITEMLISTBYTASKID,
                             {
                                 taskId: rowObject.TPId
                                 , operation: operation
                                 , collAddr: _collAddr
                             },
                             {
                                 "success": function (data) {
                                     // 结束之后重新查询
                                     if (operation == "E") {
                                         fn_Search(_disId);
                                         fn_SetGrid2([]);
                                     } else {
                                         fn_SetGrid2(JSON.parse(data.body));
                                     }

                                 },
                                 "failure": function (data) {
                                     $.sa.warning(data.msg);
                                 }
                             }, $("body"));
                }
            }
            //if (operation=="S") {
            $("button.start").css("background-color","#4BACC6");
            $("button.end").css("background-color","#4BACC6");
            $(obj).css("background-color","#7F7F7F");
            _currentObjMST = rowObject;
            //}
        }

        function fn_CloseTaskPlan(rowId, operation, obj){
            if (operation =="C") {
                $.sa.confirm('确定要取消该任务吗？', {
                    fnOk: function(){
                        $(".close").click();
                        var rowObject = $("#gridTask").jqGrid('getRowData', rowId);
                        _tpStatus = rowObject.TPStatus;
                        _rowNo = rowId
                        var tpType = rowObject.TPType;

                        if (tpType=="C") {
                            $.sa.get(GETCUSTOMIZEDTASKBYTASKID,
                                {
                                    taskId: rowObject.TPId
                                    , operation: operation
                                    , collAddr: _collAddr
                                },
                                {
                                    "success": function (data) {
                                        fn_Search(_disId);
                                    },
                                    "failure": function (data) {
                                        $.sa.warning(data.msg);
                                    }
                                }, $("body"));

                        }else{
                            //$.sa.get("http://fiatqaapi.elandcloud.com/fiat/api/v1/Tour/GetItemListByTaskId",
                            $.sa.get(GETITEMLISTBYTASKID,
                                     {
                                         taskId: rowObject.TPId
                                         , operation: operation
                                         , collAddr: _collAddr
                                     },
                                     {
                                         "success": function (data) {
                                             fn_Search(_disId);
                                             fn_SetGrid2([]);

                                         },
                                         "failure": function (data) {
                                             $.sa.warning(data.msg);
                                         }
                                     }, $("body"));
                        }

                    }
                });
            }

        }
        function fn_Save() {
            fn_SaveCell.call(_grid2);
            var editData = _grid2.getChangedCells('all');
            if (!fn_GridValidate(editData)) {
                return;
            }
            for (var i = 0; i < editData.length; i++) {
                var item = { Score: 0, PlanApproalYN: editData[i].PlanApproalYN, ResultApproalYN: editData[i].ResultApproalYN, TPId: editData[i].TPId, TIId: editData[i].TIId, UserId: "@Context.Request.Cookies[SessionKeys.SESSION_USERID]" };
                //$.sa.post("http://fiatqaapi.elandcloud.com/fiat/api/v1/Tour/SaveItemApproalYN",
                $.sa.post(SAVEITEMAPPROALYN,
                              JSON.stringify(item),
                              {
                                  "success": function (data) {
                                      $.sa.alert("保存成功");
                                      $("#gridTask").find("tr[id='" + _rowNo + "']").find(".start").click();
                                  },
                                  "failure": function (data) {
                                      $.sa.alert("保存失败");
                                  }
                              }, $("body"));
            }
        }

        //经销商Pop
        function fn_SelectDistributor(id) {
            if ($("#selPlanLst").val()==="select") {
                $.sa.warning("请选择巡检月份");
                $("#selPlanLst").focus();
                return;
            }
            $.sa.pop('/Tour/TOU010P', {
                height: 500, width: 600, title: '<span class="fa fa-hand-o-right gap-icon-right"></span><span>经销商列表</span>',
                params: {
                    Type:"R"
                    , Batch: $("#selPlanLst").val()
                }
               , popcallback: function (msg) {
                   if (msg != null && msg.length > 0) {
                       $(".input-group input:text").eq(0).val(msg[0].DisCode);
                       $(".input-group input:text").eq(1).val(msg[0].DisName);
                       _disId = msg[0].DisId;
                       fn_Search(_disId);
                   }
               }
            });
        }
        //得分登记Pop
        function fn_ScoreRegPop(rowId) {
            var rowObject = $("#gridItem").jqGrid('getRowData', rowId);
            var popHeight = 520;
            var popWidth = 1030;
            if (_WAPYN) {
                popHeight = $(document.body).height() - 40;
                popWidth = $(document).width() - 160;
            }else {
                popHeight = 520;
                popWidth = 1030;
            }
            if (_currentObjMST.TPStatus == "检查完成") {
                $.sa.pop('/Tour/TOU020P', {
                    height: popHeight, width: popWidth, title: '<span class="fa fa-hand-o-right gap-icon-right"></span><span>检核结果</span>',
                    params: {
                        TPId: rowObject.TPId,
                        TIId: rowObject.TIId,
                        SeqNo: rowObject.SeqNo
                    }
              , popcallback: function (msg) {
                  if (msg != null && msg.length > 0) {
                      $("#gridTask").find("tr[id='" + _rowNo + "']").find(".start").click();
                  }
              }
                });
            }else{
                $.sa.pop('/Tour/TOU011P', {
                    height: popHeight, width: popWidth, title: '<span class="fa fa-hand-o-right gap-icon-right"></span><span>检核登记</span>',
                    params: {
                        TPId: rowObject.TPId,
                        TIId: rowObject.TIId,
                        SeqNo: rowObject.SeqNo
                    }
                  , popcallback: function (msg) {
                      if (msg != null && msg.length > 0) {
                          $("#gridTask").find("tr[id='" + _rowNo + "']").find(".start").click();
                      }
                  }
                });

                $("body").find(".close").unbind("click");
                $("body").find(".close").on("click",function(){
                    if ($("iframe").contents().find("#divStatus").text()==="C") {
                        $.sa.warning("有要保存的数据,请先保存");
                        return;
                    }else{
                        $(".dialog").stop();
                        $(".dialog-mask").stop();

                        $(".dialog").fadeOut("slow", function () { removeDialog($(".dialog"), $(".dialog-mask")); });
                        $(".dialog-mask").fadeOut("normal");
                    }

                    function removeDialog(dl,dm){
                        var $dliframe = dl.find("iframe");
                        if ($dliframe != "undefined")
                        {
                            $dliframe.attr("src", "");
                            $dliframe.remove();
                        }
                        document.body.removeChild(dl[0]);
                        document.body.removeChild(dm[0]);
                    }
                });
            }
        }
        //自定义任务检核Pop
        function fn_CustomizedTaskPop(tPId,operation,tpStatus) {
            $.sa.pop('/Tour/TOU012P', {
                height: 400, width: 600, title: '<span class="fa fa-hand-o-right gap-icon-right"></span><span>自定义任务检核</span>',
                params: {
                    TPId:tPId
                    ,Operation:operation
                    ,TPStatus:tpStatus
                }
              , popcallback: function (msg) {
                  if (msg != null && msg.length > 0) {

                  }
              }
            });
        }

        function fn_OpenImpItemRegPop(){
            if(_disId==undefined||_disId==0){
                $.sa.warning("请选择经销商！");
            }else{
                $.sa.pop('/Tour/TOU013P', {
                    height: 470, width: 600, title: '<span class="fa fa-hand-o-right gap-icon-right"></span><span>自定义改善登记</span>',
                    params: {
                        pamDisId:_disId
                    }
                 , popcallback: function (msg) {
                     if (msg != null) {
                         fn_Search(_disId);
                     }
                 }
                });
            }
        }

        //Excel上传
        function fn_ExcelUpload(obj) {
            var score=JSON.parse(JSON.parse(obj).Result).Score;
            var checkresult=JSON.parse(JSON.parse(obj).Result).CheckResult;
            score.splice(0,1);
            checkresult.splice(0,1);
            var item = {InUserId:@Context.Request.Cookies[SessionKeys.SESSION_USERID],Plans:JSON.parse(JSON.parse(obj).Result).Plans,TaskOfPlans:JSON.parse(JSON.parse(obj).Result).TaskOfPlans,TaskCard:JSON.parse(JSON.parse(obj).Result).TaskCard
            ,TaskItem:JSON.parse(JSON.parse(obj).Result).TaskItem,CheckStandard:JSON.parse(JSON.parse(obj).Result).CheckStandard,Score:score,CheckResult:checkresult,PictureStandard:JSON.parse(JSON.parse(obj).Result).PictureStandard};
            //$.sa.post('http://localhost:6505/fiat/api/v1/PlanTask/ExcelUploadPlans',
            $.sa.post(EXCELUPLOADPLANS,
                          JSON.stringify(item),
                          {
                              "success": function (data) {
                                  if (data != null && data.msg == "") {
                                      $.sa.warning("保存成功！");
                                      //fn_ClosePlan();
                                  }else if(data != null && data.msg != "")
                                  {
                                      $.sa.warning(data.msg);
                                  }
                                  else {
                                      $.sa.warning("保存失败！");
                                      //fn_SetGrid("");
                                  }
                              },
                              "failure": function (data, statusText, jqXHR) {
                                  //fn_SetGrid("");
                                  $.sa.warning(data.msg);
                              }
                          }, $("body"));
        }

        //查询检核类型
        function fn_SetVType() {
            $.sa.get(
                         TASKGETSTATUS,
                         { GroupCode: '09' ,BusId:"@Context.Request.Cookies[SessionKeys.SESSION_ORGBIZID]"},
                         {
                             "success": function (data) {
                                 if (data != null) {
                                     var jData=JSON.parse(data.body);
                                     if (jData.length ==1) {
                                         $('#selVisitType').html(JsonToCboList("Name", "Value", JSON.parse(data.body)));
                                         $("#selVisitType").prop("disabled",true);
                                     }
                                     else{
                                         $('#selVisitType').html(JsonToCboList("Name", "Value", JSON.parse(data.body)));
                                         $("#selVisitType").prop("disabled",false);
                                     }
                                     fn_getPlans();
                                 }
                             },
                             "failure": function (data, statusText, jqXHR) {
                                 $.sa.warning(data.msg);
                             }
                         });
        }

        //巡检月份
        function fn_getPlans() {
            $.sa.get(GETPLANSBYORGANIZATION
               , {
                   busId: "@Context.Request.Cookies[SessionKeys.SESSION_USERTYPE]"==="A"?"0":"@Context.Request.Cookies[SessionKeys.SESSION_ORGBIZID]"
                   , repId: "@Context.Request.Cookies[SessionKeys.SESSION_ORGREPID]"===""?"0":"@Context.Request.Cookies[SessionKeys.SESSION_ORGREPID]"
                   , areaId: "@Context.Request.Cookies[SessionKeys.SESSION_ORGZIONID]"===""?"0":"@Context.Request.Cookies[SessionKeys.SESSION_ORGZIONID]"
                   , zoneId: "@Context.Request.Cookies[SessionKeys.SESSION_ORGAREAID]"===""?"0":"@Context.Request.Cookies[SessionKeys.SESSION_ORGAREAID]"
                   , vType: $.trim($("#selVisitType").val())
                   , status:"N"
               },
             {
                 "success": function (data) {
                     var result = JSON.parse(data.body);
                     $("#selPlanLst").html(JsonToCboList("Name", "Value", result, { 'SelectType': 'SELECT' }));
                     fn_SetServerData();
                 },
                 "failure": function (data, statusText, jqXHR) {
                 }
             });
        }
    </script>
    <!-- 5. Grid -->
    <script type="text/javascript">
        function fn_GridInit() {
            _grid.jqGrid({
                datatype: 'local',
                colModel: [
                        {
                            name: 'TCCode', label: "任务代码", width: 200, align: 'center',
                            cellattr: function (rowId, val, rawObject, cm, rdata) {
                                return 'class="readonlycell"';
                            },hidden:true
                        },
                        {
                            name: 'PTitle', label: "计划任务", width: 250, align: 'left',hidden:true,
                            cellattr: function (rowId, val, rawObject, cm, rdata) {
                                return 'class="readonlycell"';
                            }
                        },
                          {
                              name: '', label: '开始', width: 63, align: 'center', editable: false,
                              formatter: fn_CheckStart, unformat: fn_UnCheckStart
                          },
                        {
                            name: '', label: '结束', width: 63, align: 'center', editable: false,
                            formatter: fn_CheckEnd, unformat: fn_UnCheckEnd
                        }
                        , {
                            name: 'TPStatus', label: '状态', width: 60, align: 'center', editable: false,
                            formatter: function (cellvalue, options, rowObject) {
                                if (cellvalue == "E") {
                                    return "检查完成";
                                } else {
                                    return "未结束";
                                }

                            }, unformat: function (cellvalue, options, rowObject) {
                                return cellvalue;
                            }, cellattr: function (rowId, val, rawObject, cm, rdata) {
                                return 'class="readonlycell"';
                            }
                        },
                        {
                            name: 'TCTitle', label: "模块简介", width: 160, align: 'left',
                            cellattr: function (rowId, val, rawObject, cm, rdata) {
                                return 'class="readonlycell"';
                            }
                        },
                        {
                            name: 'LastTCScore', label: '明检得分', width:70, align: 'right',
                            cellattr: function (rowId, val, rawObject, cm, rdata) {
                                return 'class="readonlycell"';
                            }
                        },
                        {
                            name: 'TCWeight', label: '权重', width: 60, align: 'right',
                            cellattr: function (rowId, val, rawObject, cm, rdata) {
                                return 'class="readonlycell"';
                            }, formatter: function (cellvalue, options, rowObject) {
                                return (cellvalue * 100).toFixed(2) + "%";
                            }
                        },{
                            name: 'UserName', label: "制作者", width: 80, align: 'center',hidden:true,
                            cellattr: function (rowId, val, rawObject, cm, rdata) {
                                return 'class="readonlycell"';
                            }
                        },

                        {
                            name: '', label: '取消任务', width: 100, align: 'center', editable: false,
                            //formatter: fn_CloseTask, unformat: fn_UnCloseTask,
                            hidden:true
                        },
                        {
                            name: 'TPId', label: 'TPId', width: 50, align: 'center', editable: false, hidden: true
                        },
                        {
                            name: 'TPType', label: 'TPType', width: 50, align: 'center', editable: false, hidden: true
                        }

                ],
                //width: $('#Grid').width(),
                width: '300px',
                shrinkToFit:false,
                height: 'auto',
                rownumbers: true,
                rownumWidth: 40,
                rowNum: 10,
                rowList: [10, 20, 30],
                footerrow: false,
                cellsubmit: 'clientArray',
                pager: jQuery('#pager1'),
                cellEdit: true,
                editurl: 'clientArray',
                viewrecords: true,
                gridComplete: function (id) {
                    var rowNum = parseInt($(this).getGridParam("records"), 10);
                    if (rowNum > 0) {
                        $(".ui-jqgrid-sdiv").show();
                    }
                    else {
                        $(".ui-jqgrid-sdiv").hide();
                    }
                    $('#pager1_left').css('width', '25%');
                    $('#pager1_right').css('width', '25%');

                    $("[aria-describedby='gridTask_rn']").addClass("readonlycell");
                },
                afterInsertRow: function (rowid, r) {
                    //var $t = $(this);
                    //if (r.TPStatus != "E") {
                    //    $t.find('#' + rowid).find(".start").attr("disabled", false);
                    //    $t.find('#' + rowid).find("[aria-describedby='grid_TPStatus']").addClass("readonlycell");
                    //}
                    //if (r.TPStatus == "S") {
                    //    $t.find('#' + rowid).find(".end").attr("disabled", false);
                    //    $t.find('#' + rowid).find("[aria-describedby='grid_TPStatus']").addClass("readonlycell");
                    //}
                }
            });
        }

        function fn_SetGrid(mydata) {
            mydata = mydata || [];
            _grid.clearGridData()
                .setGridParam({
                    data: mydata
                }).trigger('reloadGrid');
            localdata = mydata;
        }

        function fn_GridInit2() {
            _grid2.jqGrid({
                datatype: 'local',
                colModel: [
                        {
                            name: 'SeqNo', label: "执行顺序", width: 80, align: 'center',hidden:true,
                            cellattr: function (rowId, val, rawObject, cm, rdata) {
                                return 'class="readonlycell"';
                            }
                        },
                        {
                            name: 'Score', label: '检核登记', width: 86, align: 'center', editable: false,
                            formatter: fn_ScoreReg, unformat: fn_UnScoreReg
                        },
                        {
                            name: 'Title', label: "指标名称", width: 142, align: 'left',
                            cellattr: function (rowId, val, rawObject, cm, rdata) {
                                return 'class="readonlycell"';
                            }
                        },
                        {
                            name: 'TIWeight', label: '权重', width: 60, align: 'right',
                            cellattr: function (rowId, val, rawObject, cm, rdata) {
                                return 'class="readonlycell"';
                            }, formatter: function (cellvalue, options, rowObject) {
                                return (cellvalue * 100).toFixed(2) + "%";
                            }
                        },
                        {
                            name: 'PassYN', label: '是否达标', width: 63, align: 'center', editable: false,
                            cellattr: function (rowId, val, rawObject, cm, rdata) {
                                return 'class="readonlycell"';
                            }
                        },
                        {
                            name: 'LastScore', label: '明检得分', width: 63, align: 'center', editable: false,
                            cellattr: function (rowId, val, rawObject, cm, rdata) {
                                return 'class="readonlycell"';
                            }
                        },

                        {
                            name: 'PlanApproalYN', label: '改善计划审批', width: 50, align: 'center', editable: false, edittype: "text", hidden: true
                            , formatter: 'select', edittype: 'select',
                            formatoptions: {
                                value: { true: "需要", false: "不需要" }
                            }, editoptions: {
                                'class': 'form-control',
                                value: { true: "需要", false: "不需要" }
                            },
                            cellattr: function (rowId, val, rawObject, cm, rdata) {
                                return 'class="readonlycell"';
                            }

                        },
                        {
                            name: 'ResultApproalYN', label: '改善结果审批', width: 50, align: 'center', editable: false, edittype: "text", hidden: true
                            , formatter: 'select', edittype: 'select',
                            formatoptions: {
                                value: { true: "需要", false: "不需要" }
                            }, editoptions: {
                                'class': 'form-control',
                                value: { true: "需要", false: "不需要" }
                            },
                            cellattr: function (rowId, val, rawObject, cm, rdata) {
                                return 'class="readonlycell"';
                            }
                        },
                        {
                            name: 'TPId', label: 'TPId', width: 50, align: 'center', editable: false, hidden: true
                        },
                        {
                            name: 'TIId', label: 'TIId', width: 50, align: 'center', editable: false, hidden: true
                        }
                ],
                width:'300px',
                shrinkToFit:false,
                height: 'auto',
                rownumbers: true,
                rownumWidth: 40,
                rowNum: 10,
                rowList: [10, 20, 30],
                footerrow: false,
                cellsubmit: 'clientArray',
                pager: jQuery('#pager2'),
                cellEdit: true,
                editurl: 'clientArray',
                viewrecords: true,
                gridComplete: function (id) {
                    var rowNum = parseInt($(this).getGridParam("records"), 10);
                    if (rowNum > 0) {
                        $(".ui-jqgrid-sdiv").show();
                    }
                    else {
                        $(".ui-jqgrid-sdiv").hide();
                    }
                    $('#pager2_left').css('width', '25%');
                    $('#pager2_right').css('width', '25%');

                    $("[aria-describedby='gridItem_rn']").addClass("readonlycell");
                },
                afterInsertRow: function (rowid, r) {
                    var $t = $(this);
                    //if (_tpStatus == "检查完成") {
                    //    $t.find('#' + rowid).find("[aria-describedby='gridItem_PlanApproalYN']").addClass("readonlycell");
                    //    $t.find('#' + rowid).find("[aria-describedby='gridItem_ResultApproalYN']").addClass("readonlycell");
                    //} else if (r.PassYN == "通过") {
                    //    $t.find('#' + rowid).find("[aria-describedby='gridItem_PlanApproalYN']").addClass("readonlycell");
                    //    $t.find('#' + rowid).find("[aria-describedby='gridItem_ResultApproalYN']").addClass("readonlycell");
                    //}

                }, onCellSelect: function (rowid, iCol, cellcontent, e) {
                    //var rowdata = $("#gridItem").jqGrid('getRowData', rowid);

                    //if (_tpStatus == "检查完成") {
                    //    $("#gridItem").setColProp('PlanApproalYN', { 'editable': false });
                    //    $("#gridItem").setColProp('ResultApproalYN', { 'editable': false });
                    //} else {
                    //    if (rowdata.PassYN == "通过") {
                    //        $("#gridItem").setColProp('PlanApproalYN', { 'editable': false });
                    //        $("#gridItem").setColProp('ResultApproalYN', { 'editable': false });
                    //    } else {
                    //        $("#gridItem").setColProp('PlanApproalYN', { 'editable': true });
                    //        $("#gridItem").setColProp('ResultApproalYN', { 'editable': true });
                    //    }
                    //}
                }
            });
        }

        function fn_SetGrid2(mydata) {
            mydata = mydata || [];
            _grid2.clearGridData()
                .setGridParam({
                    data: mydata
                }).trigger('reloadGrid');
            localdata = mydata;
        }

        function fn_SaveCell() {
            var $t = $(this);
            var $ecs = $(".edit-cell", $t);
            $ecs.each(function (idx, ec) {
                var iRow = $(ec).parent().index();
                var iCol = $(ec).index();
                $t.saveCell(iRow, iCol);
            });
        }
    </script>
}

<div class="row gap-top">
    <div class="col-md-12">
        <span class="fa fa-flag fa-lg gap-icon"></span><span class="page-mtitle">巡视检核</span><span>&nbsp;>&nbsp;</span><span class="page-title">检核登记</span>
        <div class="pull-right hidden">
            <button type="button" class="btn btn-primary" id="btnSearch">
                <span class="fa fa-search gap-icon"></span>查询
            </button>
        </div>
    </div>
</div>
<div class="row gap-top">
    <div class="col-md-12 col-sm-12 hidden-xs">
        <div class="pull-right">
            <button id="btnImpItem" class="btn btn-primary hidden">
                <span class="fa fa-pencil gap-icon"></span>改善登记
            </button>
            <button id="btnExcelUpload" class="btn btn-primary hidden">
                <span class="fa fa-file-excel-o gap-icon"></span>Excel上传
            </button>
            <button id="btnExcelDown" class="btn btn-primary hidden">
                <span class="fa fa-file-excel-o gap-icon"></span>Excel模板下载
            </button>
            <a href="~/Template/检核登记模板.xlsx" class="aline" id="a" style="display:none">Excel模板下载</a>
        </div>
    </div>
</div>
<div class="row gap-top">
    <div class="col-md-3 col-sm-3">
        <div class="input-group">
            <span class="input-group-addon title-sm "><font color="red">* </font>检核类型</span>
            <select class="form-control" id="selVisitType"></select>
        </div>
    </div>
    <div class="col-md-4 col-sm-4">
        <div class="input-group">
            <span class="input-group-addon title-sm "><font color="red">* </font>巡检月份</span>
            <select class="form-control" id="selPlanLst"></select><!--期次-->
        </div>
    </div>
    <div class="col-md-5 col-sm-5">
        <div class="form-inline input-group hidden-xs">
            <label class="input-group-addon title-sm">经销商</label>
            <input type="text" class="form-control inputWidth" disabled>
            <button class="btn btn-primary" style="float:left;padding-left:8px;padding-right:8px;" id="btnSelect">选择</button>
            <input type="text" class="form-control inputMaxWidth" disabled>
        </div>
        <div class="input-group hidden-lg hidden-md hidden-sm">
            <span class="input-group-addon title-sm">经销商</span>
            <select class="form-control" id="selServerLst"></select>
        </div>
    </div>
</div>

<div class="row gap-top" style="display:none;">
    <form method="post" enctype="multipart/form-data">
        <div class="form-group">
            <div class="col-md-3">
                <input id="files" name="files" type="file" style="display:none" />
                <input id="fileText" type="text" class="form-control" disabled />
            </div>
            <div class="col-md-0">
                <button type="button" class="btn btn-primary" onclick="$('#files').click()">浏览</button>
                <input type="button" id="upload" class="btn btn-primary" value="Excel上传" />
            </div>
        </div>
    </form>
</div>
<div style="height:20px;"></div>
<div class="row">
    <div class="col-md-7 col-sm-12 col-xs-12 pull-left" style="width:460px;">
        <div id="divDealerTScore" class="pull-right" style="padding:5px;"></div>
    </div>
</div>
<div class="row">
    <div id="Grid" class="col-md-7 col-sm-12 col-xs-12">
        <table id="gridTask" class="ui-jqgrid-htable"></table>
        <div id="pager1" class="page">
        </div>
        <div class="pull-left" style="color:red">备注：此明检得分为近一期季度明检得分。</div>
    </div>

    <div id="Grid2" class="col-md-5 col-sm-12 col-xs-12">
        <table id="gridItem" class="ui-jqgrid-htable"></table>
        <div id="pager2" class="page">
        </div>
    </div>
</div>
<div class="row" style="padding-top:5px;padding-bottom:5px;">
    <div class="col-md-12 ">
        <div class="pull-right">
            <button type="button" class="btn btn-primary hidden" id="btnSave">
                <span class="fa fa-save gap-icon"></span>保存
            </button>
        </div>
    </div>
</div>
<div class="row">

</div>
